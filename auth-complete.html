<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Microsoft Sign-In</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <style>
            :root {
                color-scheme: light dark;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            body {
                margin: 0;
                min-height: 100vh;
                display: grid;
                place-items: center;
                background: radial-gradient(circle at top, #eef2ff, #e2e8f0);
                color: #0f172a;
            }
            .card {
                background: rgba(255, 255, 255, 0.9);
                border-radius: 24px;
                box-shadow: 0 30px 60px -35px rgba(15, 23, 42, 0.55);
                padding: 32px;
                text-align: center;
                max-width: 360px;
                width: calc(100% - 32px);
            }
            h1 {
                font-size: 1.4rem;
                margin-bottom: 0.75rem;
            }
            p {
                margin: 0;
                font-size: 0.95rem;
                color: #475569;
            }
        </style>
    </head>
    <body>
        <div class="card">
            <h1>Completing sign-inâ€¦</h1>
            <p>You can close this tab.</p>
        </div>
        <script>
            (function () {
                function parseParams(raw) {
                    const params = new URLSearchParams(raw);
                    const result = {};
                    params.forEach((value, key) => {
                        result[key] = value;
                    });
                    return result;
                }

                const hash = window.location.hash ? window.location.hash.substring(1) : '';
                const search = window.location.search ? window.location.search.substring(1) : '';
                const raw = hash || search;
                const data = raw ? parseParams(raw) : {};
                const state = data.state || null;
                const storageKey = state ? 'gmct-msal:' + state : null;

                let sessionData = null;
                if (storageKey) {
                    try {
                        sessionData = JSON.parse(window.sessionStorage.getItem(storageKey));
                    } catch (error) {
                        console.warn('Unable to parse pending Microsoft sign-in session.', error);
                    }
                }

                const origin = sessionData && sessionData.origin ? sessionData.origin : window.location.origin;
                const payload = {
                    type: 'gmct-ms-login',
                    state: state,
                    accessToken: data.access_token || null,
                    idToken: data.id_token || null,
                    expiresIn: data.expires_in || null,
                    scope: data.scope || null,
                    tokenType: data.token_type || null,
                    error: data.error || null,
                    errorDescription: data.error_description || null,
                    tenant: sessionData ? sessionData.tenant : null,
                };

                try {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage(payload, origin);
                    }
                } catch (error) {
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage(payload, '*');
                    }
                }

                window.setTimeout(function () {
                    window.close();
                }, 120);
            })();
        </script>
    </body>
</html>
