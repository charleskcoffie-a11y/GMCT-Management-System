<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>GMCT Management System</title>
    <link rel="manifest" href="./manifest.json" />
    <meta name="theme-color" content="#4338ca" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Immediately unregister any previously installed service workers before the
      // main bundle runs. This ensures visitors who are stuck on the loading screen
      // because of an outdated offline cache get a clean reload path.
      (function uncacheLegacyServiceWorkers() {
        try {
          if ('serviceWorker' in navigator) {
            const { serviceWorker } = navigator;
            if (typeof serviceWorker.getRegistrations === 'function') {
              serviceWorker
                .getRegistrations()
                .then(registrations => {
                  registrations.forEach(registration => {
                    registration.unregister().catch(() => {
                      /* swallow errors - the React boot process will log details */
                    });
                  });
                })
                .catch(() => {
                  /* ignore lookup errors */
                });
            } else if (typeof serviceWorker.getRegistration === 'function') {
              serviceWorker
                .getRegistration()
                .then(registration => {
                  if (registration) {
                    registration.unregister().catch(() => {
                      /* swallow errors - the React boot process will log details */
                    });
                  }
                })
                .catch(() => {
                  /* ignore lookup errors */
                });
            }
          }

          if ('caches' in window) {
            caches
              .keys()
              .then(keys => {
                keys
                  .filter(key => key.startsWith('gmct'))
                  .forEach(key => {
                    caches.delete(key).catch(() => {
                      /* ignore cache cleanup errors */
                    });
                  });
              })
              .catch(() => {
                /* ignore cache enumeration errors */
              });
          }
        } catch (error) {
          console.warn('Failed to pre-emptively clear legacy service workers.', error);
        }
      })();
    </script>
    <script>
      // If the React bundle fails to mark the boot flag within a few seconds, force
      // a cache-busting reload so visitors are not trapped on the loading screen.
      window.addEventListener('load', () => {
        window.setTimeout(() => {
          if (window.__gmctAppBooted || window.__gmctBootstrapFailed) {
            return;
          }

          const root = document.getElementById('root');
          if (root) {
            const notice = document.createElement('p');
            notice.style.marginTop = '1.5rem';
            notice.style.color = '#b91c1c';
            notice.style.fontWeight = '600';
            notice.textContent = 'We could not start the application automatically. Reloading to clear the cache...';
            root.appendChild(notice);
          }

          try {
            const retryUrl = new URL(window.location.href);
            retryUrl.searchParams.set('cache-bust', Date.now().toString());
            window.location.replace(retryUrl.toString());
          } catch (error) {
            console.warn('Failed to issue automatic cache-busting reload.', error);
            window.location.reload();
          }
        }, 6000);
      });
    </script>
    <style>
      html, body, #root {
        height: 100%;
      }
      /* Increase base font size for better readability as requested */
      body {
        font-size: 18px;
        background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 40%, #fdf2f8 100%);
        overflow-y: auto;
      }
      /* Custom scrollbar for a more polished, less "dry" look */
      ::-webkit-scrollbar {
        width: 8px;
        height: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f5f9; /* bg-slate-100 */
      }
      ::-webkit-scrollbar-thumb {
        background: #a5b4fc; /* indigo-300 */
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #818cf8; /* indigo-400 */
      }
    </style>
  </head>
  <body>
    <div id="root">
      <!-- Failsafe Loading Message -->
      <!-- This is displayed if the main JavaScript fails to load or execute. -->
      <!-- It will be automatically removed by index.tsx once React is ready. -->
      <div style="font-family: ui-sans-serif, system-ui, sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f8fafc;">
        <div style="text-align: center; padding: 2rem; background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); border: 1px solid #e2e8f0;">
          <h1 style="font-size: 1.5rem; font-weight: 600; color: #1e293b;">Loading Application...</h1>
          <p style="margin-top: 1rem; color: #475569;">If this message remains on screen for more than a few seconds, a critical error likely occurred.</p>
          <p style="margin-top: 0.5rem; font-size: 0.875rem; color: #64748b;">Please try a hard refresh (<strong style="font-weight: 600;">Ctrl+Shift+R</strong> or <strong style="font-weight: 600;">Cmd+Shift+R</strong>) and check the browser's developer console for specific error messages.</p>
        </div>
      </div>
    </div>
    <!-- The main application script, deferred to run after the document is parsed -->
    <script type="module">
      const root = document.getElementById('root');

      const renderBootstrapError = (title, bodyLines) => {
        if (!root) {
          return;
        }

        root.innerHTML = '';

        const container = document.createElement('div');
        container.style.fontFamily = 'ui-sans-serif, system-ui, sans-serif';
        container.style.backgroundColor = '#fff1f2';
        container.style.border = '1px solid #fda4af';
        container.style.borderRadius = '0.75rem';
        container.style.padding = '1.75rem';
        container.style.maxWidth = '42rem';
        container.style.margin = '2.5rem auto';
        container.style.boxShadow = '0 20px 45px -15px rgba(190, 18, 60, 0.35)';

        const heading = document.createElement('h2');
        heading.textContent = title;
        heading.style.fontSize = '1.35rem';
        heading.style.fontWeight = '700';
        heading.style.color = '#9f1239';
        container.appendChild(heading);

        bodyLines.forEach(line => {
          const paragraph = document.createElement('p');
          paragraph.textContent = line;
          paragraph.style.marginTop = '0.75rem';
          paragraph.style.color = '#7f1d1d';
          paragraph.style.lineHeight = '1.5';
          container.appendChild(paragraph);
        });

        root.appendChild(container);
      };

      const describeFailure = error => {
        try {
          if (!error) {
            return [];
          }
          const reason = error?.message || String(error);
          const guidance = [];

          if (/Unexpected token|Unexpected identifier|Cannot use import statement/.test(reason)) {
            guidance.push('The browser received raw TypeScript files. Confirm GitHub Pages is configured to deploy from “GitHub Actions” and that the latest “Deploy to GitHub Pages” workflow run succeeded.');
          }

          if (navigator.onLine === false) {
            guidance.push('You appear to be offline. Reconnect to the internet and reload the page.');
          }

          guidance.push(`Technical details: ${reason}`);
          return guidance;
        } catch (fallbackError) {
          console.warn('Failed to render detailed bootstrap guidance.', fallbackError);
          return [];
        }
      };

      const markBootstrapFailure = error => {
        window.__gmctBootstrapFailed = true;
        window.__gmctBootstrapError = error?.message || String(error) || 'Unknown error';
      };

      const markBootstrapPending = () => {
        window.__gmctBootstrapFailed = false;
        window.__gmctBootstrapError = undefined;
      };

      markBootstrapPending();

      import('./index.tsx').catch(error => {
        console.error('Failed to load the GMCT Management System bundle.', error);
        markBootstrapFailure(error);

        const guidance = describeFailure(error);
        renderBootstrapError('Application bundle could not start', [
          'The compiled application failed to load, so the interface is unavailable right now.',
          ...guidance,
          'If the issue persists after reloading, open the browser console and share the full error log with the support team.',
        ]);
      });
    </script>
  </body>
</html>
